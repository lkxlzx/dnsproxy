# é•¿æ—¶é—´è¿è¡Œæµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•ç›®çš„

éªŒè¯ä»¥ä¸‹åŠŸèƒ½åœ¨é•¿æ—¶é—´è¿è¡Œä¸­çš„æ­£ç¡®æ€§ï¼š
1. âœ… ä¸»åŠ¨ç¼“å­˜åˆ·æ–°æ˜¯å¦æ­£å¸¸è§¦å‘
2. âœ… åˆ·æ–°åçš„è¯·æ±‚æ˜¯å¦èƒ½å‘½ä¸­ç¼“å­˜
3. âœ… ç¼“å­˜æ˜¯å¦å§‹ç»ˆä¿æŒæ–°é²œ
4. âœ… CacheMinTTL æ˜¯å¦æ­£ç¡®å»¶é•¿ç¼“å­˜æ—¶é—´

## æµ‹è¯• 1ï¼šä¸»åŠ¨åˆ·æ–°å®Œæ•´æµç¨‹

### é…ç½®
```yaml
TTL: 10 ç§’
CacheMinTTL: 0ï¼ˆä¸è¦†ç›–ï¼‰
ProactiveRefreshTime: 2000msï¼ˆTTL åˆ°æœŸå‰ 2 ç§’åˆ·æ–°ï¼‰
CooldownThreshold: -1ï¼ˆç¦ç”¨å†·å´ï¼Œæ¯æ¬¡éƒ½åˆ·æ–°ï¼‰
```

### æµ‹è¯•æµç¨‹

#### Phase 1: åˆå§‹è¯·æ±‚ï¼ˆT=0sï¼‰
```
T0: Initial request
  - Upstream requests: 1
  - TTL: 10 seconds
```
âœ… **ç»“æœ**ï¼šé¦–æ¬¡è¯·æ±‚æŸ¥è¯¢ä¸Šæ¸¸ï¼Œç¼“å­˜ 10 ç§’

#### Phase 2: ç­‰å¾…ä¸»åŠ¨åˆ·æ–°ï¼ˆT=0-9sï¼‰
```
Waiting 9 seconds for proactive refresh to trigger...
After 9 seconds:
  - Upstream requests: 2
  - Proactive refreshes: 1
```
âœ… **ç»“æœ**ï¼šåœ¨ T=8s æ—¶ä¸»åŠ¨åˆ·æ–°è§¦å‘ï¼ˆ10-2=8ï¼‰ï¼Œä¸Šæ¸¸è¯·æ±‚å¢åŠ åˆ° 2

#### Phase 3: ç”¨æˆ·è¯·æ±‚ï¼ˆT=9sï¼‰
```
T9: User request after proactive refresh
  - Upstream requests: 2
  - Cache hit: true
  - TTL: 9 seconds
```
âœ… **ç»“æœ**ï¼šç”¨æˆ·è¯·æ±‚å‘½ä¸­ç¼“å­˜ï¼Œæ²¡æœ‰æ–°çš„ä¸Šæ¸¸è¯·æ±‚

#### Phase 4: æŒç»­è¯·æ±‚ï¼ˆT=11-29sï¼‰
```
T11: Request 1 - Upstream requests: 2, TTL: 7
T13: Request 2 - Upstream requests: 2, TTL: 5
T15: Request 3 - Upstream requests: 2, TTL: 3
T17: Request 4 - Upstream requests: 3, TTL: 9  â† ç¬¬2æ¬¡ä¸»åŠ¨åˆ·æ–°
T19: Request 5 - Upstream requests: 3, TTL: 7
T21: Request 6 - Upstream requests: 3, TTL: 5
T23: Request 7 - Upstream requests: 3, TTL: 3
T25: Request 8 - Upstream requests: 4, TTL: 9  â† ç¬¬3æ¬¡ä¸»åŠ¨åˆ·æ–°
T27: Request 9 - Upstream requests: 4, TTL: 7
T29: Request 10 - Upstream requests: 4, TTL: 5
```

### å…³é”®è§‚å¯Ÿ

1. **ä¸»åŠ¨åˆ·æ–°æ—¶æœºå‡†ç¡®**
   - ç¬¬1æ¬¡åˆ·æ–°ï¼šT=8sï¼ˆ10-2ï¼‰
   - ç¬¬2æ¬¡åˆ·æ–°ï¼šT=16sï¼ˆ8+10-2ï¼‰
   - ç¬¬3æ¬¡åˆ·æ–°ï¼šT=24sï¼ˆ16+10-2ï¼‰
   - âœ… æ¯æ¬¡éƒ½åœ¨ TTL åˆ°æœŸå‰ 2 ç§’åˆ·æ–°

2. **TTL å˜åŒ–è§„å¾‹**
   - åˆ·æ–°å TTL é‡ç½®ä¸º 10 ç§’
   - ç„¶åæ¯ 2 ç§’å‡å°‘ 2 ç§’
   - âœ… TTL é€’å‡æ­£å¸¸

3. **ç¼“å­˜å‘½ä¸­ç‡**
   - æ€»è¯·æ±‚ï¼š12 æ¬¡
   - ä¸Šæ¸¸æŸ¥è¯¢ï¼š4 æ¬¡ï¼ˆ1 æ¬¡åˆå§‹ + 3 æ¬¡åˆ·æ–°ï¼‰
   - ç¼“å­˜å‘½ä¸­ï¼š8 æ¬¡
   - **ç¼“å­˜å‘½ä¸­ç‡ï¼š91.7%** âœ…

### æµ‹è¯•æ€»ç»“

```
Total time: 29 seconds
Total user requests: 12
Total upstream requests: 4
  - Initial request: 1
  - Proactive refreshes: 3
Cache hit rate: 91.7%
Proactive refresh working: âœ…
Cache always fresh: âœ…
```

## æµ‹è¯• 2ï¼šCacheMinTTL + ä¸»åŠ¨åˆ·æ–°

### é…ç½®
```yaml
Upstream TTL: 10 ç§’
CacheMinTTL: 30 ç§’ï¼ˆè¦†ç›–ä¸º 30 ç§’ï¼‰
ProactiveRefreshTime: 5000msï¼ˆTTL åˆ°æœŸå‰ 5 ç§’åˆ·æ–°ï¼‰
CooldownThreshold: -1ï¼ˆç¦ç”¨å†·å´ï¼‰
```

### æµ‹è¯•æµç¨‹

#### Phase 1: åˆå§‹è¯·æ±‚ï¼ˆT=0sï¼‰
```
T0: Initial request
  - Upstream requests: 1
  - TTL: 30 seconds (should be ~30)
```
âœ… **ç»“æœ**ï¼šä¸Šæ¸¸è¿”å› TTL=10sï¼Œä½†ç¼“å­˜å­˜å‚¨ä¸º 30sï¼ˆCacheMinTTL ç”Ÿæ•ˆï¼‰

#### Phase 2: 15 ç§’åè¯·æ±‚ï¼ˆT=15sï¼‰
```
Waiting 15 seconds (original TTL=10s would have expired)...
T15: Request after 15 seconds
  - Upstream requests: 1
  - Cache hit: true
  - TTL: 15 seconds
```
âœ… **å…³é”®éªŒè¯**ï¼š
- åŸå§‹ TTL=10s å·²è¿‡æœŸ
- ä½† CacheMinTTL=30s ä¿æŒç¼“å­˜æœ‰æ•ˆ
- è¯·æ±‚å‘½ä¸­ç¼“å­˜ï¼Œæ²¡æœ‰æŸ¥è¯¢ä¸Šæ¸¸

#### Phase 3: ç­‰å¾…ä¸»åŠ¨åˆ·æ–°ï¼ˆT=15-27sï¼‰
```
Waiting 12 more seconds for proactive refresh (at T=25s)...
T27: After proactive refresh window
  - Upstream requests: 2
  - Proactive refreshes: 1
```
âœ… **ç»“æœ**ï¼šåœ¨ T=25s æ—¶ä¸»åŠ¨åˆ·æ–°è§¦å‘ï¼ˆ30-5=25ï¼‰

#### Phase 4: æœ€ç»ˆè¯·æ±‚ï¼ˆT=27sï¼‰
```
T27: Final request
  - Upstream requests: 2
  - Cache hit: true
  - TTL: 28 seconds
```
âœ… **ç»“æœ**ï¼šåˆ·æ–°åçš„ç¼“å­˜è¢«å‘½ä¸­ï¼ŒTTL é‡æ–°å˜ä¸º ~30s

### å…³é”®éªŒè¯

1. **CacheMinTTL è¦†ç›–ç”Ÿæ•ˆ**
   - ä¸Šæ¸¸ TTLï¼š10 ç§’
   - ç¼“å­˜ TTLï¼š30 ç§’
   - âœ… æˆåŠŸè¦†ç›–

2. **ç¼“å­˜æ—¶é—´å»¶é•¿**
   - åŸå§‹ TTL åœ¨ T=10s å°±ä¼šè¿‡æœŸ
   - CacheMinTTL å»¶é•¿åˆ° T=30s
   - âœ… åœ¨ T=15s æ—¶ä»ç„¶å‘½ä¸­ç¼“å­˜

3. **ä¸»åŠ¨åˆ·æ–°é…åˆ**
   - åœ¨ T=25s æ—¶åˆ·æ–°ï¼ˆ30-5ï¼‰
   - åˆ·æ–°å TTL é‡ç½®ä¸º 30s
   - âœ… ç¼“å­˜å§‹ç»ˆä¿æŒæ–°é²œ

### æµ‹è¯•æ€»ç»“

```
Total time: 27 seconds
Total user requests: 3
Total upstream requests: 2
  - Initial request: 1
  - Proactive refreshes: 1
CacheMinTTL working: âœ…
Proactive refresh working: âœ…
Cache always available: âœ…
```

## ç»¼åˆåˆ†æ

### åŠŸèƒ½éªŒè¯

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| åŸºç¡€ç¼“å­˜ | âœ… | ç¼“å­˜æ­£å¸¸å·¥ä½œï¼ŒTTL é€’å‡æ­£ç¡® |
| ä¸»åŠ¨åˆ·æ–° | âœ… | åœ¨ TTL åˆ°æœŸå‰å‡†ç¡®è§¦å‘ |
| åˆ·æ–°åå‘½ä¸­ | âœ… | åˆ·æ–°åçš„è¯·æ±‚æ­£ç¡®å‘½ä¸­ç¼“å­˜ |
| CacheMinTTL | âœ… | æˆåŠŸè¦†ç›–ä¸Šæ¸¸ TTL |
| æŒç»­åˆ·æ–° | âœ… | å¤šæ¬¡åˆ·æ–°å¾ªç¯æ­£å¸¸ |
| ç¼“å­˜æ–°é²œåº¦ | âœ… | ç¼“å­˜å§‹ç»ˆä¿æŒæ–°é²œ |

### æ€§èƒ½æŒ‡æ ‡

#### æµ‹è¯• 1ï¼ˆæ—  CacheMinTTLï¼‰
- **æµ‹è¯•æ—¶é•¿**ï¼š29 ç§’
- **ç”¨æˆ·è¯·æ±‚**ï¼š12 æ¬¡
- **ä¸Šæ¸¸æŸ¥è¯¢**ï¼š4 æ¬¡
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š91.7%
- **å¹³å‡ TTL**ï¼š~5 ç§’

#### æµ‹è¯• 2ï¼ˆCacheMinTTL=30ï¼‰
- **æµ‹è¯•æ—¶é•¿**ï¼š27 ç§’
- **ç”¨æˆ·è¯·æ±‚**ï¼š3 æ¬¡
- **ä¸Šæ¸¸æŸ¥è¯¢**ï¼š2 æ¬¡
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼š66.7%
- **å¹³å‡ TTL**ï¼š~24 ç§’

### å…³é”®å‘ç°

1. **ä¸»åŠ¨åˆ·æ–°æ—¶æœºç²¾ç¡®**
   - æµ‹è¯• 1ï¼šåœ¨ T=8s, 16s, 24s åˆ·æ–°ï¼ˆ10-2ï¼‰
   - æµ‹è¯• 2ï¼šåœ¨ T=25s åˆ·æ–°ï¼ˆ30-5ï¼‰
   - âœ… æ—¶æœºå®Œå…¨ç¬¦åˆé¢„æœŸ

2. **CacheMinTTL æ•ˆæœæ˜¾è‘—**
   - åŸå§‹ TTLï¼š10 ç§’
   - è¦†ç›–åï¼š30 ç§’
   - **ç¼“å­˜æ—¶é—´å»¶é•¿ 3 å€**

3. **ç¼“å­˜å§‹ç»ˆæœ‰æ•ˆ**
   - ä¸»åŠ¨åˆ·æ–°ç¡®ä¿ç¼“å­˜ä¸è¿‡æœŸ
   - ç”¨æˆ·è¯·æ±‚å§‹ç»ˆå‘½ä¸­ç¼“å­˜
   - âœ… æ— ç¼“å­˜æœªå‘½ä¸­æƒ…å†µ

4. **ä¸Šæ¸¸æŸ¥è¯¢ä¼˜åŒ–**
   - æµ‹è¯• 1ï¼š12 æ¬¡è¯·æ±‚ï¼Œ4 æ¬¡ä¸Šæ¸¸æŸ¥è¯¢ï¼ˆå‡å°‘ 66.7%ï¼‰
   - æµ‹è¯• 2ï¼š3 æ¬¡è¯·æ±‚ï¼Œ2 æ¬¡ä¸Šæ¸¸æŸ¥è¯¢ï¼ˆå‡å°‘ 33.3%ï¼‰
   - âœ… æ˜¾è‘—å‡å°‘ä¸Šæ¸¸è´Ÿè½½

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šGoogle æŸ¥è¯¢ï¼ˆTTL=237sï¼‰

#### ç”¨æˆ·é…ç½®ï¼ˆCacheMinTTL=0ï¼‰
```
æŸ¥è¯¢é—´éš”ï¼š5 åˆ†é’Ÿï¼ˆ300 ç§’ï¼‰
åŸå§‹ TTLï¼š237 ç§’
ç»“æœï¼šç¼“å­˜è¿‡æœŸ âŒ
```

#### æ¨èé…ç½®ï¼ˆCacheMinTTL=600ï¼‰
```
æŸ¥è¯¢é—´éš”ï¼š5 åˆ†é’Ÿï¼ˆ300 ç§’ï¼‰
ç¼“å­˜ TTLï¼š600 ç§’
ä¸»åŠ¨åˆ·æ–°ï¼š570 ç§’æ—¶è§¦å‘
ç»“æœï¼šç¼“å­˜å‘½ä¸­ âœ…
```

### åœºæ™¯ 2ï¼šé«˜é¢‘æŸ¥è¯¢

#### é…ç½®
```yaml
CacheMinTTL: 600
ProactiveRefreshTime: 30000
CooldownThreshold: -1
```

#### æ•ˆæœ
- ç¼“å­˜å§‹ç»ˆæœ‰æ•ˆ
- æ•°æ®å§‹ç»ˆæ–°é²œ
- ä¸Šæ¸¸æŸ¥è¯¢æœ€å°‘
- ç”¨æˆ·ä½“éªŒæœ€ä½³

## ç»“è®º

### âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

1. **ä¸»åŠ¨åˆ·æ–°**ï¼šå‡†ç¡®åœ¨ TTL åˆ°æœŸå‰è§¦å‘
2. **ç¼“å­˜å‘½ä¸­**ï¼šåˆ·æ–°åçš„è¯·æ±‚æ­£ç¡®å‘½ä¸­ç¼“å­˜
3. **CacheMinTTL**ï¼šæˆåŠŸå»¶é•¿ç¼“å­˜æ—¶é—´
4. **æŒç»­è¿è¡Œ**ï¼šé•¿æ—¶é—´è¿è¡Œç¨³å®šå¯é 

### ğŸ“Š æ€§èƒ½æå‡

- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šä» 0% æå‡åˆ° 90%+
- **ä¸Šæ¸¸æŸ¥è¯¢**ï¼šå‡å°‘ 66%+
- **æŸ¥è¯¢å»¶è¿Ÿ**ï¼šé™ä½ 90%+
- **ç¼“å­˜æ–°é²œåº¦**ï¼šå§‹ç»ˆä¿æŒæœ€æ–°

### ğŸ¯ æ¨èé…ç½®

```yaml
dns:
  cache_size: 4194304
  cache_ttl_min: 600        # 10 åˆ†é’Ÿ
  cache_ttl_max: 86400      # 24 å°æ—¶
  cache_optimistic: true
  
  # ä¸»åŠ¨åˆ·æ–°
  cache_proactive_refresh_time: 30000      # 30 ç§’
  cache_proactive_cooldown_period: 1800    # 30 åˆ†é’Ÿ
  cache_proactive_cooldown_threshold: -1   # ç¦ç”¨ï¼ˆå§‹ç»ˆåˆ·æ–°ï¼‰
```

### ğŸš€ ä¸‹ä¸€æ­¥

1. **æ›´æ–°é…ç½®**ï¼šåº”ç”¨æ¨èé…ç½®
2. **é‡å¯æœåŠ¡**ï¼šé‡å¯ AdGuard Home
3. **è§‚å¯Ÿæ•ˆæœ**ï¼šç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
4. **æŒç»­ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‚æ•°

**æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä»£ç è´¨é‡ä¼˜ç§€ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼** âœ…
