# 循环刷新设计说明

## 核心设计理念

**循环刷新是主动缓存刷新的核心特性，而非缺陷。**

## 工作原理

### 热门域名的生命周期

```
阶段 1: 用户开始访问
├─ 用户请求 1 → 缓存创建 → 统计: 1
├─ 用户请求 2 → 缓存命中 → 统计: 2
└─ 用户请求 3 → 缓存命中 → 统计: 3 → ✅ 达到阈值

阶段 2: 启动循环刷新
├─ T0+30s: 定时器触发 → 主动刷新 → 新缓存 → 再次调度
├─ T0+60s: 定时器触发 → 主动刷新 → 新缓存 → 再次调度
├─ T0+90s: 定时器触发 → 主动刷新 → 新缓存 → 再次调度
└─ 持续循环... 🔄

阶段 3: 自动停止（用户停止访问）
├─ 最后一次用户请求: T0+120s
├─ T0+150s: 冷却周期（30分钟）内仍有统计 → 继续刷新
├─ T0+1920s: 超出冷却周期 → 统计过期
└─ 下次刷新时检查 → 不满足阈值 → ❌ 停止刷新
```

## 为什么需要循环刷新？

### 问题场景

假设**不循环刷新**：

```
T0:   用户请求 → 缓存创建（TTL=60s）
T30:  主动刷新 → 新缓存（TTL=60s）
T90:  缓存过期 → 用户请求 → 缓存未命中 ❌
```

**结果**：用户在 T90 时遇到缓存未命中，体验下降。

### 解决方案：循环刷新

```
T0:   用户请求 → 缓存创建（TTL=60s）
T30:  主动刷新 → 新缓存（TTL=60s）→ 再次调度 ✅
T60:  主动刷新 → 新缓存（TTL=60s）→ 再次调度 ✅
T90:  主动刷新 → 新缓存（TTL=60s）→ 再次调度 ✅
...   持续保持缓存新鲜
```

**结果**：用户始终命中缓存，体验最佳 ✅

## 资源控制

### 问题：会不会无限刷新浪费资源？

**答案：不会，有多重保护机制**

### 保护机制 1：冷却阈值

```go
CacheProactiveCooldownThreshold: 3  // 需要至少 3 次请求
```

- 低频域名（< 3 次请求）不会启动循环刷新
- 只有热门域名才会循环刷新

### 保护机制 2：滑动时间窗口

```go
CacheProactiveCooldownPeriod: 1800  // 30 分钟
```

- 只统计 30 分钟内的请求
- 用户停止访问后，统计自动过期
- 统计过期后，循环刷新自动停止

### 保护机制 3：主动刷新也计入统计

```
主动刷新 → 调用 set() → recordRequest() → 统计 +1
```

- 主动刷新会更新统计时间戳
- 保持统计在冷却周期内
- 但如果没有真实用户请求，最终仍会过期

## 实际效果

### 测试结果

#### 测试 1：持续刷新（热门域名）

```
配置：TTL=3秒，刷新提前1秒，冷却禁用
结果：10秒内产生 4 次刷新
结论：✅ 循环刷新正常工作
```

#### 测试 2：自动停止（冷门域名）

```
配置：TTL=2秒，冷却周期=3秒，阈值=2
结果：冷却期过后刷新停止
结论：✅ 自动停止机制正常工作
```

## 配置建议

### 场景 1：高价值域名（如 API 端点）

```go
CacheProactiveRefreshTime: 5000         // 5秒前刷新
CacheProactiveCooldownPeriod: 300       // 5分钟
CacheProactiveCooldownThreshold: 1      // 1次请求即刷新
```

**效果**：几乎所有域名都会持续刷新，保证最高可用性

### 场景 2：平衡模式（推荐）

```go
CacheProactiveRefreshTime: 30000        // 30秒前刷新
CacheProactiveCooldownPeriod: 1800      // 30分钟
CacheProactiveCooldownThreshold: 3      // 3次请求
```

**效果**：只刷新真正的热门域名，平衡性能和资源

### 场景 3：节省资源

```go
CacheProactiveRefreshTime: 60000        // 60秒前刷新
CacheProactiveCooldownPeriod: 3600      // 60分钟
CacheProactiveCooldownThreshold: 10     // 10次请求
```

**效果**：只刷新非常热门的域名，最大化节省资源

## 常见问题

### Q1: 循环刷新会不会导致上游服务器压力过大？

**A**: 不会，因为：
1. 只有满足阈值的热门域名才会刷新
2. 刷新频率 = 1 / TTL，可控
3. 可以通过提高阈值来减少刷新的域名数量

### Q2: 如果用户停止访问，刷新什么时候停止？

**A**: 在冷却周期过期后自动停止：
- 最后一次用户请求：T0
- 冷却周期：30 分钟
- 停止时间：T0 + 30 分钟 + 几个 TTL 周期

### Q3: 主动刷新算不算"用户请求"？

**A**: 算，但有区别：
- 主动刷新会更新统计时间戳
- 但如果没有真实用户请求，统计最终会过期
- 这是合理的：如果域名真的热门，会有持续的用户请求

### Q4: 可以禁用循环刷新吗？

**A**: 不建议，但可以通过配置减少影响：
- 提高冷却阈值（如 100）→ 只有超热门域名才刷新
- 缩短冷却周期（如 60 秒）→ 快速停止刷新
- 增加刷新提前时间（如 TTL 的 90%）→ 减少刷新频率

## 总结

**循环刷新是精心设计的特性，而非缺陷：**

✅ **目标**：保持热门域名缓存始终新鲜  
✅ **机制**：自动循环刷新  
✅ **控制**：冷却机制防止资源浪费  
✅ **停止**：用户停止访问后自动停止  
✅ **效果**：最佳用户体验 + 合理资源消耗  

**这正是主动缓存刷新的核心价值所在！** 🎯
